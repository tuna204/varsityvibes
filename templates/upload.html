<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Varsity Vibes | Upload Design</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      min-height: 100vh;
    }
    .card {
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 30px rgba(0,0,0,0.2);
    }
    input, button {
      outline: none;
    }
    input[type="text"], input[type="file"] {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 100%;
      padding: 10px;
      border-radius: 0.5rem;
    }
    input::file-selector-button {
      background: #6d28d9;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    .disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body class="text-white flex flex-col items-center py-10">

  <h1 class="text-4xl font-bold mb-8 bg-gradient-to-r from-pink-400 to-blue-400 text-transparent bg-clip-text">
    Varsity Vibes x Irys Upload Center
  </h1>

  <div class="w-full max-w-2xl card rounded-2xl p-8">
    <h2 class="text-2xl mb-4 font-semibold">Upload Jersey Design</h2>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="mb-4">
          {% for message in messages %}
            <li class="text-center bg-green-500/20 border border-green-500 py-2 px-4 rounded-xl">
              {{ message }}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form id="uploadForm" method="POST" enctype="multipart/form-data" class="space-y-4">
      <div>
        <label class="block text-sm mb-1">File:</label>
        <input type="file" name="file" required>
      </div>

      <div>
        <label class="block text-sm mb-1">Owner Address:</label>
        <input type="text" name="owner_address" placeholder="Enter your wallet address" required>
      </div>

      <div>
        <label class="block text-sm mb-1">Irys Address:</label>
        <input type="text" id="irys_address_input" placeholder="Enter Irys address" required>
      </div>

      <div>
        <label class="block text-sm mb-1">Access Rule:</label>
        <input type="text" name="rule" placeholder="e.g. VarsityPass holders only" required>
      </div>

      <hr class="my-6 border-gray-400/30">

      <!-- Irys → Execution Address Section -->
      <h3 class="text-lg font-semibold mb-2">Irys → Execution Address</h3>
      <div class="space-y-2">
        <input type="hidden" id="exec_address_input" name="exec_address">
        <p class="text-sm text-gray-300">Exec Address: <span id="exec_address_output" class="text-pink-400">—</span></p>

        <div class="flex gap-3">
          <button type="button" id="convertBtn"
                  class="bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-2 rounded-lg text-white hover:scale-105 transition">
              Convert Address
          </button>

          <button type="button"
                  onclick="generateFakeIrysAddress()"
                  class="bg-green-500 px-3 py-2 rounded-lg">
              Generate Irys Address
          </button>
        </div>
      </div>

      <div class="flex justify-between items-center pt-4">
        <a href="{{ url_for('files') }}" 
           class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg text-white">View Uploaded Files</a>
        <button type="submit" id="uploadBtn"
           class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-2 rounded-lg text-white hover:scale-105 transition">
           Upload
        </button>
      </div>
    </form>
  </div>

<script>
// --- Base58 Alphabet ---
const ALPHABET = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";

// Decode Base58 → Uint8Array
function base58Decode(str) {
    let bytes = [0];
    for (let char of str) {
        const index = ALPHABET.indexOf(char);
        if (index === -1) throw new Error("Invalid Base58 character");
        let carry = index;
        for (let i = 0; i < bytes.length; i++) {
            carry += bytes[i] * 58;
            bytes[i] = carry % 256;
            carry = Math.floor(carry / 256);
        }
        while (carry > 0) {
            bytes.push(carry % 256);
            carry = Math.floor(carry / 256);
        }
    }
    return new Uint8Array(bytes.reverse());
}

// Convert Base58 Irys → EVM Exec Address
function irysToExecLocal(irysAddr) {
    const decoded = base58Decode(irysAddr);
    const last20 = decoded.slice(-20);
    let hex = "0x";
    for (const byte of last20) {
        hex += byte.toString(16).padStart(2, "0");
    }
    return hex;
}

// Convert button / auto-convert
function convertAddress() {
    const irysInput = document.getElementById("irys_address_input").value.trim();
    if (!irysInput) {
        document.getElementById("exec_address_output").textContent = "—";
        document.getElementById("exec_address_input").value = "";
        return;
    }
    try {
        const exec = irysToExecLocal(irysInput);
        document.getElementById("exec_address_output").textContent = exec;
        document.getElementById("exec_address_input").value = exec;
    } catch (err) {
        console.error(err);
        document.getElementById("exec_address_output").textContent = "—";
        document.getElementById("exec_address_input").value = "";
        alert("Invalid Irys address format.");
    }
}

// Auto-convert on typing
document.getElementById("irys_address_input").addEventListener("input", convertAddress);
document.getElementById("convertBtn").addEventListener("click", convertAddress);

// Fake Irys generator
function generateFakeIrysAddress() {
    let addr = "";
    for (let i = 0; i < 48; i++) {
        addr += ALPHABET[Math.floor(Math.random() * ALPHABET.length)];
    }
    document.getElementById("irys_address_input").value = addr;
    convertAddress();
}

// --- Ensure exec address is set on submit ---
const form = document.getElementById("uploadForm");
form.addEventListener("submit", (e) => {
    const irysAddr = document.getElementById("irys_address_input").value.trim();
    if (!irysAddr) {
        e.preventDefault();
        alert("Please enter your Irys address.");
        return;
    }

    try {
        const exec = irysToExecLocal(irysAddr);
        document.getElementById("exec_address_input").value = exec;
    } catch (err) {
        e.preventDefault();
        alert("Invalid Irys address format.");
        return;
    }
});
</script>

</body>
</html>
